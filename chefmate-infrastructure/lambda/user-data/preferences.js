"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const dynamodb_client_1 = require("../shared/dynamodb-client");
const DEFAULT_PREFERENCES = {
    dietaryRestrictions: [],
    allergies: [],
    favoriteCuisines: [],
    dislikedIngredients: [],
    cookingSkillLevel: 'intermediate',
    maxCookingTime: 60,
    servingSize: 2,
};
/**
 * User Preferences Lambda Handler
 *
 * Routes:
 * - GET /user/preferences - Get user preferences
 * - PUT /user/preferences - Update user preferences
 */
async function handler(event) {
    console.log('Preferences Lambda invoked:', {
        method: event.httpMethod,
        path: event.path,
    });
    const userId = (0, dynamodb_client_1.getUserIdFromEvent)(event);
    if (!userId) {
        return (0, dynamodb_client_1.buildResponse)(401, { error: 'Unauthorized: User ID not found in token' });
    }
    const userPK = `USER#${userId}`;
    const sk = 'PREFERENCES';
    try {
        switch (event.httpMethod) {
            case 'GET':
                return await getPreferences(userPK, sk);
            case 'PUT':
                return await updatePreferences(userPK, sk, event.body);
            default:
                return (0, dynamodb_client_1.buildResponse)(405, { error: `Method ${event.httpMethod} not allowed` });
        }
    }
    catch (error) {
        console.error('Error in preferences handler:', error);
        return (0, dynamodb_client_1.buildResponse)(500, {
            error: 'Internal server error',
            message: error instanceof Error ? error.message : 'Unknown error',
        });
    }
}
/**
 * Get user preferences, return defaults if none exist
 */
async function getPreferences(userPK, sk) {
    const item = await (0, dynamodb_client_1.getItem)(userPK, sk);
    if (!item) {
        // Return default preferences for new users
        return (0, dynamodb_client_1.buildResponse)(200, {
            preferences: DEFAULT_PREFERENCES,
            isDefault: true,
        });
    }
    // Transform to frontend format (remove PK/SK)
    const preferences = {
        dietaryRestrictions: item.dietaryRestrictions,
        allergies: item.allergies,
        favoriteCuisines: item.favoriteCuisines,
        dislikedIngredients: item.dislikedIngredients,
        cookingSkillLevel: item.cookingSkillLevel,
        maxCookingTime: item.maxCookingTime,
        servingSize: item.servingSize,
    };
    return (0, dynamodb_client_1.buildResponse)(200, { preferences, isDefault: false });
}
/**
 * Update user preferences (merge with existing)
 */
async function updatePreferences(userPK, sk, body) {
    if (!body) {
        return (0, dynamodb_client_1.buildResponse)(400, { error: 'Request body is required' });
    }
    let input;
    try {
        input = JSON.parse(body);
    }
    catch {
        return (0, dynamodb_client_1.buildResponse)(400, { error: 'Invalid JSON in request body' });
    }
    // Validate input
    const validationError = validatePreferences(input);
    if (validationError) {
        return (0, dynamodb_client_1.buildResponse)(400, { error: validationError });
    }
    // Get existing preferences to merge
    const existing = await (0, dynamodb_client_1.getItem)(userPK, sk);
    const now = new Date().toISOString();
    const preferences = {
        dietaryRestrictions: input.dietaryRestrictions ?? existing?.dietaryRestrictions ?? DEFAULT_PREFERENCES.dietaryRestrictions,
        allergies: input.allergies ?? existing?.allergies ?? DEFAULT_PREFERENCES.allergies,
        favoriteCuisines: input.favoriteCuisines ?? existing?.favoriteCuisines ?? DEFAULT_PREFERENCES.favoriteCuisines,
        dislikedIngredients: input.dislikedIngredients ?? existing?.dislikedIngredients ?? DEFAULT_PREFERENCES.dislikedIngredients,
        cookingSkillLevel: input.cookingSkillLevel ?? existing?.cookingSkillLevel ?? DEFAULT_PREFERENCES.cookingSkillLevel,
        maxCookingTime: input.maxCookingTime ?? existing?.maxCookingTime ?? DEFAULT_PREFERENCES.maxCookingTime,
        servingSize: input.servingSize ?? existing?.servingSize ?? DEFAULT_PREFERENCES.servingSize,
        createdAt: existing?.createdAt ?? now,
    };
    await (0, dynamodb_client_1.putItem)(userPK, sk, preferences);
    return (0, dynamodb_client_1.buildResponse)(200, {
        message: 'Preferences updated',
        preferences,
    });
}
/**
 * Validate preferences input
 */
function validatePreferences(input) {
    if (input.dietaryRestrictions && !Array.isArray(input.dietaryRestrictions)) {
        return 'dietaryRestrictions must be an array';
    }
    if (input.allergies && !Array.isArray(input.allergies)) {
        return 'allergies must be an array';
    }
    if (input.favoriteCuisines && !Array.isArray(input.favoriteCuisines)) {
        return 'favoriteCuisines must be an array';
    }
    if (input.dislikedIngredients && !Array.isArray(input.dislikedIngredients)) {
        return 'dislikedIngredients must be an array';
    }
    if (input.cookingSkillLevel && !['beginner', 'intermediate', 'advanced'].includes(input.cookingSkillLevel)) {
        return 'cookingSkillLevel must be beginner, intermediate, or advanced';
    }
    if (input.maxCookingTime !== undefined && (typeof input.maxCookingTime !== 'number' || input.maxCookingTime < 0)) {
        return 'maxCookingTime must be a positive number';
    }
    if (input.servingSize !== undefined && (typeof input.servingSize !== 'number' || input.servingSize < 1)) {
        return 'servingSize must be a positive number';
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmVyZW5jZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcmVmZXJlbmNlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWlEQSwwQkFnQ0M7QUFoRkQsK0RBS21DO0FBMEJuQyxNQUFNLG1CQUFtQixHQUFtRTtJQUMxRixtQkFBbUIsRUFBRSxFQUFFO0lBQ3ZCLFNBQVMsRUFBRSxFQUFFO0lBQ2IsZ0JBQWdCLEVBQUUsRUFBRTtJQUNwQixtQkFBbUIsRUFBRSxFQUFFO0lBQ3ZCLGlCQUFpQixFQUFFLGNBQWM7SUFDakMsY0FBYyxFQUFFLEVBQUU7SUFDbEIsV0FBVyxFQUFFLENBQUM7Q0FDZixDQUFDO0FBRUY7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLE9BQU8sQ0FBQyxLQUEyQjtJQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFO1FBQ3pDLE1BQU0sRUFBRSxLQUFLLENBQUMsVUFBVTtRQUN4QixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7S0FDakIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxNQUFNLEdBQUcsSUFBQSxvQ0FBa0IsRUFBQyxLQUFLLENBQUMsQ0FBQztJQUN6QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDWixPQUFPLElBQUEsK0JBQWEsRUFBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsMENBQTBDLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLENBQUM7SUFFRCxNQUFNLE1BQU0sR0FBRyxRQUFRLE1BQU0sRUFBRSxDQUFDO0lBQ2hDLE1BQU0sRUFBRSxHQUFHLGFBQWEsQ0FBQztJQUV6QixJQUFJLENBQUM7UUFDSCxRQUFRLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN6QixLQUFLLEtBQUs7Z0JBQ1IsT0FBTyxNQUFNLGNBQWMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFMUMsS0FBSyxLQUFLO2dCQUNSLE9BQU8sTUFBTSxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsRUFBRSxF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QUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUN2RCxPQUFPLDRCQUE0QixDQUFDO0lBQ3RDLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztRQUNyRSxPQUFPLG1DQUFtQyxDQUFDO0lBQzdDLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQztRQUMzRSxPQUFPLHNDQUFzQyxDQUFDO0lBQ2hELENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztRQUMzRyxPQUFPLCtEQUErRCxDQUFDO0lBQ3pFLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxjQUFjLEtBQUssU0FBUyxJQUFJLENBQUMsT0FBTyxLQUFLLENBQUMsY0FBYyxLQUFLLFFBQVEsSUFBSSxLQUFLLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDakgsT0FBTywwQ0FBMEMsQ0FBQztJQUNwRCxDQUFDO0lBQ0QsSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLFNBQVMsSUFBSSxDQUFDLE9BQU8sS0FBSyxDQUFDLFdBQVcsS0FBSyxRQUFRLElBQUksS0FBSyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3hHLE9BQU8sdUNBQXVDLENBQUM7SUFDakQsQ0FBQztJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7XG4gIGdldFVzZXJJZEZyb21FdmVudCxcbiAgZ2V0SXRlbSxcbiAgcHV0SXRlbSxcbiAgYnVpbGRSZXNwb25zZSxcbn0gZnJvbSAnLi4vc2hhcmVkL2R5bmFtb2RiLWNsaWVudCc7XG5cbmludGVyZmFjZSBVc2VyUHJlZmVyZW5jZXMge1xuICBQSzogc3RyaW5nO1xuICBTSzogc3RyaW5nO1xuICBkaWV0YXJ5UmVzdHJpY3Rpb25zOiBzdHJpbmdbXTtcbiAgYWxsZXJnaWVzOiBzdHJpbmdbXTtcbiAgZmF2b3JpdGVDdWlzaW5lczogc3RyaW5nW107XG4gIGRpc2xpa2VkSW5ncmVkaWVudHM6IHN0cmluZ1tdO1xuICBjb29raW5nU2tpbGxMZXZlbDogJ2JlZ2lubmVyJyB8ICdpbnRlcm1lZGlhdGUnIHwgJ2FkdmFuY2VkJztcbiAgbWF4Q29va2luZ1RpbWU6IG51bWJlcjtcbiAgc2VydmluZ1NpemU6IG51bWJlcjtcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgUHJlZmVyZW5jZXNJbnB1dCB7XG4gIGRpZXRhcnlSZXN0cmljdGlvbnM/OiBzdHJpbmdbXTtcbiAgYWxsZXJnaWVzPzogc3RyaW5nW107XG4gIGZhdm9yaXRlQ3Vpc2luZXM/OiBzdHJpbmdbXTtcbiAgZGlzbGlrZWRJbmdyZWRpZW50cz86IHN0cmluZ1tdO1xuICBjb29raW5nU2tpbGxMZXZlbD86ICdiZWdpbm5lcicgfCAnaW50ZXJtZWRpYXRlJyB8ICdhZHZhbmNlZCc7XG4gIG1heENvb2tpbmdUaW1lPzogbnVtYmVyO1xuICBzZXJ2aW5nU2l6ZT86IG51bWJlcjtcbn1cblxuY29uc3QgREVGQVVMVF9QUkVGRVJFTkNFUzogT21pdDxVc2VyUHJlZmVyZW5jZXMsICdQSycgfCAnU0snIHwgJ2NyZWF0ZWRBdCcgfCAndXBkYXRlZEF0Jz4gPSB7XG4gIGRpZXRhcnlSZXN0cmljdGlvbnM6IFtdLFxuICBhbGxlcmdpZXM6IFtdLFxuICBmYXZvcml0ZUN1aXNpbmVzOiBbXSxcbiAgZGlzbGlrZWRJbmdyZWRpZW50czogW10sXG4gIGNvb2tpbmdTa2lsbExldmVsOiAnaW50ZXJtZWRpYXRlJyxcbiAgbWF4Q29va2luZ1RpbWU6IDYwLFxuICBzZXJ2aW5nU2l6ZTogMixcbn07XG5cbi8qKlxuICogVXNlciBQcmVmZXJlbmNlcyBMYW1iZGEgSGFuZGxlclxuICpcbiAqIFJvdXRlczpcbiAqIC0gR0VUIC91c2VyL3ByZWZlcmVuY2VzIC0gR2V0IHVzZXIgcHJlZmVyZW5jZXNcbiAqIC0gUFVUIC91c2VyL3ByZWZlcmVuY2VzIC0gVXBkYXRlIHVzZXIgcHJlZmVyZW5jZXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc29sZS5sb2coJ1ByZWZlcmVuY2VzIExhbWJkYSBpbnZva2VkOicsIHtcbiAgICBtZXRob2Q6IGV2ZW50Lmh0dHBNZXRob2QsXG4gICAgcGF0aDogZXZlbnQucGF0aCxcbiAgfSk7XG5cbiAgY29uc3QgdXNlcklkID0gZ2V0VXNlcklkRnJvbUV2ZW50KGV2ZW50KTtcbiAgaWYgKCF1c2VySWQpIHtcbiAgICByZXR1cm4gYnVpbGRSZXNwb25zZSg0MDEsIHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQ6IFVzZXIgSUQgbm90IGZvdW5kIGluIHRva2VuJyB9KTtcbiAgfVxuXG4gIGNvbnN0IHVzZXJQSyA9IGBVU0VSIyR7dXNlcklkfWA7XG4gIGNvbnN0IHNrID0gJ1BSRUZFUkVOQ0VTJztcblxuICB0cnkge1xuICAgIHN3aXRjaCAoZXZlbnQuaHR0cE1ldGhvZCkge1xuICAgICAgY2FzZSAnR0VUJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IGdldFByZWZlcmVuY2VzKHVzZXJQSywgc2spO1xuXG4gICAgICBjYXNlICdQVVQnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdXBkYXRlUHJlZmVyZW5jZXModXNlclBLLCBzaywgZXZlbnQuYm9keSk7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBidWlsZFJlc3BvbnNlKDQwNSwgeyBlcnJvcjogYE1ldGhvZCAke2V2ZW50Lmh0dHBNZXRob2R9IG5vdCBhbGxvd2VkYCB9KTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gcHJlZmVyZW5jZXMgaGFuZGxlcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIGJ1aWxkUmVzcG9uc2UoNTAwLCB7XG4gICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICB9KTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB1c2VyIHByZWZlcmVuY2VzLCByZXR1cm4gZGVmYXVsdHMgaWYgbm9uZSBleGlzdFxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRQcmVmZXJlbmNlcyh1c2VyUEs6IHN0cmluZywgc2s6IHN0cmluZyk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGl0ZW0gPSBhd2FpdCBnZXRJdGVtPFVzZXJQcmVmZXJlbmNlcz4odXNlclBLLCBzayk7XG5cbiAgaWYgKCFpdGVtKSB7XG4gICAgLy8gUmV0dXJuIGRlZmF1bHQgcHJlZmVyZW5jZXMgZm9yIG5ldyB1c2Vyc1xuICAgIHJldHVybiBidWlsZFJlc3BvbnNlKDIwMCwge1xuICAgICAgcHJlZmVyZW5jZXM6IERFRkFVTFRfUFJFRkVSRU5DRVMsXG4gICAgICBpc0RlZmF1bHQ6IHRydWUsXG4gICAgfSk7XG4gIH1cblxuICAvLyBUcmFuc2Zvcm0gdG8gZnJvbnRlbmQgZm9ybWF0IChyZW1vdmUgUEsvU0spXG4gIGNvbnN0IHByZWZlcmVuY2VzOiBQcmVmZXJlbmNlc0lucHV0ID0ge1xuICAgIGRpZXRhcnlSZXN0cmljdGlvbnM6IGl0ZW0uZGlldGFyeVJlc3RyaWN0aW9ucyxcbiAgICBhbGxlcmdpZXM6IGl0ZW0uYWxsZXJnaWVzLFxuICAgIGZhdm9yaXRlQ3Vpc2luZXM6IGl0ZW0uZmF2b3JpdGVDdWlzaW5lcyxcbiAgICBkaXNsaWtlZEluZ3JlZGllbnRzOiBpdGVtLmRpc2xpa2VkSW5ncmVkaWVudHMsXG4gICAgY29va2luZ1NraWxsTGV2ZWw6IGl0ZW0uY29va2luZ1NraWxsTGV2ZWwsXG4gICAgbWF4Q29va2luZ1RpbWU6IGl0ZW0ubWF4Q29va2luZ1RpbWUsXG4gICAgc2VydmluZ1NpemU6IGl0ZW0uc2VydmluZ1NpemUsXG4gIH07XG5cbiAgcmV0dXJuIGJ1aWxkUmVzcG9uc2UoMjAwLCB7IHByZWZlcmVuY2VzLCBpc0RlZmF1bHQ6IGZhbHNlIH0pO1xufVxuXG4vKipcbiAqIFVwZGF0ZSB1c2VyIHByZWZlcmVuY2VzIChtZXJnZSB3aXRoIGV4aXN0aW5nKVxuICovXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVQcmVmZXJlbmNlcyhcbiAgdXNlclBLOiBzdHJpbmcsXG4gIHNrOiBzdHJpbmcsXG4gIGJvZHk6IHN0cmluZyB8IG51bGxcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGlmICghYm9keSkge1xuICAgIHJldHVybiBidWlsZFJlc3BvbnNlKDQwMCwgeyBlcnJvcjogJ1JlcXVlc3QgYm9keSBpcyByZXF1aXJlZCcgfSk7XG4gIH1cblxuICBsZXQgaW5wdXQ6IFByZWZlcmVuY2VzSW5wdXQ7XG4gIHRyeSB7XG4gICAgaW5wdXQgPSBKU09OLnBhcnNlKGJvZHkpO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gYnVpbGRSZXNwb25zZSg0MDAsIHsgZXJyb3I6ICdJbnZhbGlkIEpTT04gaW4gcmVxdWVzdCBib2R5JyB9KTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGlucHV0XG4gIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IHZhbGlkYXRlUHJlZmVyZW5jZXMoaW5wdXQpO1xuICBpZiAodmFsaWRhdGlvbkVycm9yKSB7XG4gICAgcmV0dXJuIGJ1aWxkUmVzcG9uc2UoNDAwLCB7IGVycm9yOiB2YWxpZGF0aW9uRXJyb3IgfSk7XG4gIH1cblxuICAvLyBHZXQgZXhpc3RpbmcgcHJlZmVyZW5jZXMgdG8gbWVyZ2VcbiAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBnZXRJdGVtPFVzZXJQcmVmZXJlbmNlcz4odXNlclBLLCBzayk7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcblxuICBjb25zdCBwcmVmZXJlbmNlcyA9IHtcbiAgICBkaWV0YXJ5UmVzdHJpY3Rpb25zOiBpbnB1dC5kaWV0YXJ5UmVzdHJpY3Rpb25zID8/IGV4aXN0aW5nPy5kaWV0YXJ5UmVzdHJpY3Rpb25zID8/IERFRkFVTFRfUFJFRkVSRU5DRVMuZGlldGFyeVJlc3RyaWN0aW9ucyxcbiAgICBhbGxlcmdpZXM6IGlucHV0LmFsbGVyZ2llcyA/PyBleGlzdGluZz8uYWxsZXJnaWVzID8/IERFRkFVTFRfUFJFRkVSRU5DRVMuYWxsZXJnaWVzLFxuICAgIGZhdm9yaXRlQ3Vpc2luZXM6IGlucHV0LmZhdm9yaXRlQ3Vpc2luZXMgPz8gZXhpc3Rpbmc/LmZhdm9yaXRlQ3Vpc2luZXMgPz8gREVGQVVMVF9QUkVGRVJFTkNFUy5mYXZvcml0ZUN1aXNpbmVzLFxuICAgIGRpc2xpa2VkSW5ncmVkaWVudHM6IGlucHV0LmRpc2xpa2VkSW5ncmVkaWVudHMgPz8gZXhpc3Rpbmc/LmRpc2xpa2VkSW5ncmVkaWVudHMgPz8gREVGQVVMVF9QUkVGRVJFTkNFUy5kaXNsaWtlZEluZ3JlZGllbnRzLFxuICAgIGNvb2tpbmdTa2lsbExldmVsOiBpbnB1dC5jb29raW5nU2tpbGxMZXZlbCA/PyBleGlzdGluZz8uY29va2luZ1NraWxsTGV2ZWwgPz8gREVGQVVMVF9QUkVGRVJFTkNFUy5jb29raW5nU2tpbGxMZXZlbCxcbiAgICBtYXhDb29raW5nVGltZTogaW5wdXQubWF4Q29va2luZ1RpbWUgPz8gZXhpc3Rpbmc/Lm1heENvb2tpbmdUaW1lID8/IERFRkFVTFRfUFJFRkVSRU5DRVMubWF4Q29va2luZ1RpbWUsXG4gICAgc2VydmluZ1NpemU6IGlucHV0LnNlcnZpbmdTaXplID8/IGV4aXN0aW5nPy5zZXJ2aW5nU2l6ZSA/PyBERUZBVUxUX1BSRUZFUkVOQ0VTLnNlcnZpbmdTaXplLFxuICAgIGNyZWF0ZWRBdDogZXhpc3Rpbmc/LmNyZWF0ZWRBdCA/PyBub3csXG4gIH07XG5cbiAgYXdhaXQgcHV0SXRlbSh1c2VyUEssIHNrLCBwcmVmZXJlbmNlcyk7XG5cbiAgcmV0dXJuIGJ1aWxkUmVzcG9uc2UoMjAwLCB7XG4gICAgbWVzc2FnZTogJ1ByZWZlcmVuY2VzIHVwZGF0ZWQnLFxuICAgIHByZWZlcmVuY2VzLFxuICB9KTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBwcmVmZXJlbmNlcyBpbnB1dFxuICovXG5mdW5jdGlvbiB2YWxpZGF0ZVByZWZlcmVuY2VzKGlucHV0OiBQcmVmZXJlbmNlc0lucHV0KTogc3RyaW5nIHwgbnVsbCB7XG4gIGlmIChpbnB1dC5kaWV0YXJ5UmVzdHJpY3Rpb25zICYmICFBcnJheS5pc0FycmF5KGlucHV0LmRpZXRhcnlSZXN0cmljdGlvbnMpKSB7XG4gICAgcmV0dXJuICdkaWV0YXJ5UmVzdHJpY3Rpb25zIG11c3QgYmUgYW4gYXJyYXknO1xuICB9XG4gIGlmIChpbnB1dC5hbGxlcmdpZXMgJiYgIUFycmF5LmlzQXJyYXkoaW5wdXQuYWxsZXJnaWVzKSkge1xuICAgIHJldHVybiAnYWxsZXJnaWVzIG11c3QgYmUgYW4gYXJyYXknO1xuICB9XG4gIGlmIChpbnB1dC5mYXZvcml0ZUN1aXNpbmVzICYmICFBcnJheS5pc0FycmF5KGlucHV0LmZhdm9yaXRlQ3Vpc2luZXMpKSB7XG4gICAgcmV0dXJuICdmYXZvcml0ZUN1aXNpbmVzIG11c3QgYmUgYW4gYXJyYXknO1xuICB9XG4gIGlmIChpbnB1dC5kaXNsaWtlZEluZ3JlZGllbnRzICYmICFBcnJheS5pc0FycmF5KGlucHV0LmRpc2xpa2VkSW5ncmVkaWVudHMpKSB7XG4gICAgcmV0dXJuICdkaXNsaWtlZEluZ3JlZGllbnRzIG11c3QgYmUgYW4gYXJyYXknO1xuICB9XG4gIGlmIChpbnB1dC5jb29raW5nU2tpbGxMZXZlbCAmJiAhWydiZWdpbm5lcicsICdpbnRlcm1lZGlhdGUnLCAnYWR2YW5jZWQnXS5pbmNsdWRlcyhpbnB1dC5jb29raW5nU2tpbGxMZXZlbCkpIHtcbiAgICByZXR1cm4gJ2Nvb2tpbmdTa2lsbExldmVsIG11c3QgYmUgYmVnaW5uZXIsIGludGVybWVkaWF0ZSwgb3IgYWR2YW5jZWQnO1xuICB9XG4gIGlmIChpbnB1dC5tYXhDb29raW5nVGltZSAhPT0gdW5kZWZpbmVkICYmICh0eXBlb2YgaW5wdXQubWF4Q29va2luZ1RpbWUgIT09ICdudW1iZXInIHx8IGlucHV0Lm1heENvb2tpbmdUaW1lIDwgMCkpIHtcbiAgICByZXR1cm4gJ21heENvb2tpbmdUaW1lIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInO1xuICB9XG4gIGlmIChpbnB1dC5zZXJ2aW5nU2l6ZSAhPT0gdW5kZWZpbmVkICYmICh0eXBlb2YgaW5wdXQuc2VydmluZ1NpemUgIT09ICdudW1iZXInIHx8IGlucHV0LnNlcnZpbmdTaXplIDwgMSkpIHtcbiAgICByZXR1cm4gJ3NlcnZpbmdTaXplIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuIl19